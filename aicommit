#!/usr/bin/env bash
set -euo pipefail

OPENAI_API_KEY=${OPENAI_API_KEY:-sk-}
: "${OPENAI_API_KEY:?Missing OPENAI_API_KEY}"

BASE_URL="${OPENAI_BASE_URL:-https://api.llmgate.dev}"
MODEL="${OPENAI_MODEL:-gpt-5.1-codex-mini}"
TEMP="${OPENAI_TEMPERATURE:-0.2}"
MAX="${MAX_DIFF_CHARS:-12000}"

RE='^(feat|fix|build|chore|ci|docs|style|refactor|perf|test|revert)(\([a-zA-Z0-9._/-]+\))?(!)?: .+'

ADD_ALL=false
NO_CONFIRM=false
DO_PUSH=false

# -------- FLAG PARSER (supports -ayp) --------
for arg in "$@"; do
  case "$arg" in
    --all) ADD_ALL=true ;;
    --no-confirm) NO_CONFIRM=true ;;
    --push) DO_PUSH=true ;;
    -[!-]*)
      for (( i=1; i<${#arg}; i++ )); do
        case "${arg:i:1}" in
          a) ADD_ALL=true ;;
          y) NO_CONFIRM=true ;;
          p) DO_PUSH=true ;;
          *) echo "Unknown flag: -${arg:i:1}" >&2; exit 1 ;;
        esac
      done
      ;;
  esac
done
# --------------------------------------------

# -------- SPINNER --------
SPIN_PID=""

spinner_start() {
  local msg="${1:-Working...}"
  local frames='|/-\'
  (
    i=0
    while :; do
      printf "\r%s %c" "$msg" "${frames:i%${#frames}:1}"
      i=$((i+1))
      sleep 0.12
    done
  ) &
  SPIN_PID=$!
}

spinner_stop() {
  if [[ -n "${SPIN_PID:-}" ]]; then
    kill "$SPIN_PID" 2>/dev/null || true
    wait "$SPIN_PID" 2>/dev/null || true
  fi
  SPIN_PID=""
  printf "\r\033[K"
}

trap 'spinner_stop; exit 130' INT
trap 'spinner_stop' EXIT TERM
# -------------------------

$ADD_ALL && git add -A

diff="$(git diff --staged || true)"
[[ -n "$diff" ]] || { echo "No staged changes."; exit 0; }
diff="${diff:0:$MAX}"

system=$'Write a Git commit message strictly following Conventional Commits v1.0.0.\n\n- Plain text only\n- First line: type(scope)!: subject\n- type ∈ feat|fix|build|chore|ci|docs|style|refactor|perf|test|revert\n- subject imperative, <=72 chars, no trailing period\n- Add body/footer only if needed\n- Do NOT invent changes.'

user="Staged diff:\n$diff"

call_ai() {
  jq -n --arg m "$MODEL" --arg sys "$system" --arg usr "$1" --argjson t "$TEMP" '{
    model: $m,
    temperature: $t,
    input: [
      { role:"system", content: $sys },
      { role:"user",   content: $usr }
    ],
    text: { format: { type: "text" } }
  }' |
  curl -sS "$BASE_URL/v1/responses" \
    -H "Authorization: Bearer $OPENAI_API_KEY" \
    -H "Content-Type: application/json" \
    -d @- |
  jq -r '
    (
      [ .output[]?
        | select(.type=="message")
        | .content[]?
        | select(.type=="output_text")
        | .text
      ] | join("")
    ) // empty
  ' |
  sed 's/\r$//'
}

SPINNER_TEXTS=(
  "Đang tìm lý do cho mớ code này…"
  "Đang giải thích sự hỗn loạn…"
  "Đang bịa commit một cách chuyên nghiệp…"
  "Đang cố hiểu bạn vừa làm gì…"
  "Đang biến panic thành commit…"
)

spinner_start "${SPINNER_TEXTS[RANDOM % ${#SPINNER_TEXTS[@]}]}"
msg="$(call_ai "$user")"
spinner_stop

[[ -n "$msg" ]] || { echo "Empty AI response"; exit 1; }

first="$(head -n1 <<<"$msg")"
if ! [[ "$first" =~ $RE ]]; then
  spinner_start "Fixing format"
  msg="$(call_ai $'Fix ONLY formatting to match Conventional Commits v1.0.0.\nReturn plain text only.\n\nDraft:\n'"$msg")"
  spinner_stop

  first="$(head -n1 <<<"$msg")"
  [[ "$first" =~ $RE ]] || { echo "Invalid Conventional Commit: $first"; exit 1; }
fi

echo "-------------------------"
echo "$msg"
echo "-------------------------"

if ! $NO_CONFIRM; then
  read -r -p "Commit? [y/N] " yn
  [[ "$yn" =~ ^[Yy]$ ]] || exit 0
fi

tmp="$(mktemp)"
printf "%s\n" "$msg" > "$tmp"
git commit -F "$tmp"
rm -f "$tmp"

if $DO_PUSH; then
  branch="$(git rev-parse --abbrev-ref HEAD)"
  echo "Pushing to origin $branch..."
  git push origin "$branch"
fi
